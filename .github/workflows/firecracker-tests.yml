name: Firecracker Integration Tests

on:
  pull_request:
    branches: [ master ]

jobs:
  firecracker-test:
    name: Run Firecracker integration tests
    runs-on: ubuntu-22.04

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Firecracker v1.13.1
        run: |
          curl -L https://github.com/firecracker-microvm/firecracker/releases/download/v1.13.1/firecracker-v1.13.1-x86_64.tgz -o firecracker.tgz
          tar -xzf firecracker.tgz
          sudo mv release-v1.13.1-x86_64/firecracker-v1.13.1-x86_64 /usr/local/bin/firecracker
          sudo mv release-v1.13.1-x86_64/jailer-v1.13.1-x86_64 /usr/local/bin/jailer
          chmod +x /usr/local/bin/firecracker /usr/local/bin/jailer
          firecracker --version


      - name: Download test kernel and rootfs
        run: |
          mkdir -p resources
          curl -L https://s3.amazonaws.com/spec.ccfc.min/img/hello/kernel/vmlinux -o resources/vmlinux
          curl -L https://s3.amazonaws.com/spec.ccfc.min/img/hello/fsfiles/hello-rootfs.ext4 -o resources/rootfs.ext4

      - name: Run Firecracker integration tests
        run: |
          sudo chmod a+rw /dev/kvm || true
          cargo test \
            --test startup \
            --test startup_w_args \
            --test startup_w_downloading \
            --test startup_w_stdout \
            --test startup_wo_stdout \
            -- --nocapture --test-threads=1
